<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Futsal Bandula - Quarta 18h</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --card:#0b1220; --border:#1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
    background:linear-gradient(120deg,#0b1020,#0f172a 40%,#0b1020); color:var(--text)
  }
  header{
    padding:24px 16px; text-align:center; position:sticky; top:0; z-index:10;
    background:rgba(15,23,42,.85); backdrop-filter:saturate(180%) blur(8px);
    border-bottom:1px solid var(--border)
  }
  h1{margin:0 0 6px 0; font-size: clamp(20px,3.2vw,36px)}
  .sub{color:var(--muted); font-size:14px}
  .tabs{display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap}
  .tab-btn{padding:8px 16px; border-radius:10px; border:1px solid var(--border); background:var(--card); cursor:pointer}
  .tab-btn.active{background:var(--accent); color:#052e16; font-weight:700; border-color:transparent}
  .container{max-width:1200px; margin:0 auto; padding:16px}
  .hidden{display:none}
  .card{background:linear-gradient(180deg,var(--panel),var(--card));border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row.nowrap{flex-wrap:nowrap}
  .split{display:flex; gap:8px; align-items:center}
  input,select,button,textarea{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}
  input::placeholder{color:#6b7280}
  button{cursor:pointer; transition:.2s transform}
  button:hover{transform:translateY(-1px)}
  .btn.primary{background:var(--accent);color:#052e16;border:none;font-weight:700}
  .btn.positive{background:rgba(34,197,94,.25); border-color:#166534}
  .btn.negative{background:rgba(239,68,68,.2); border-color:#7f1d1d}
  .btn.danger{background:var(--danger);color:#fff;border:none;font-weight:700}
  .btn.warn{background:var(--warn);color:#3b2300;border:none;font-weight:700}
  .right{text-align:right}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid var(--border)}
  th{text-align:left;color:#cbd5e1}
  .muted{color:var(--muted)}
  .pill{padding:2px 10px; border-radius:999px; background:#0b1220; border:1px solid var(--border)}
  .pill.rank-chip{ border-color: var(--accent); color: var(--text) }
  .is-paid{background:rgba(34,197,94,.18)}
  .is-unpaid{background:rgba(239,68,68,.18)}
  .legend{display:flex; gap:10px; align-items:center; color:var(--text); font-size:12px}
  .dot{width:12px; height:12px; border-radius:3px; display:inline-block; border:1px solid var(--border)}
  .paid{background:rgba(34,197,94,.25)}
  .unpaid{background:rgba(239,68,68,.2)}
  .mensal-badge{font-size:12px; white-space:nowrap; display:inline-block; padding:2px 8px; border-radius:8px; border:1px solid var(--border)}

  /* ===== Banner do placar (feed) ===== */
  .banner .overlay{position:absolute; inset:0; background:linear-gradient(180deg,rgba(0,0,0,.12),rgba(0,0,0,.54)); pointer-events:none}
  .banner .content{position:absolute; inset:0; display:flex; flex-direction:column; justify-content:flex-end; padding:16px 16px 18px; pointer-events:none}
  .match-center{ text-align:center; font-weight:900; line-height:1.15; margin-top:0 }
  .match-center .date{ font-size:14px; color:#e5e7eb; opacity:.95; margin-bottom:6px }
  .match-center .teams{ font-size:30px }
  .match-center .score{ font-size:34px; margin-top:4px }
  .winner-badge{ display:inline-block; margin-top:6px; padding:6px 12px; border-radius:999px; background:#10b981; color:#fff; font-weight:800 }
  .players-line{ text-align:center; font-size:15px; margin-top:8px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.6) }

  .small{font-size:12px}
  .grid{display:grid; gap:16px}
  @media(min-width:960px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
  #ranking .row, #ranking .row *{white-space:nowrap}

  /* ===== Melhorias de responsividade (público) ===== */
  /* Tabelas sempre roláveis no celular */
  table{display:block; overflow-x:auto; -webkit-overflow-scrolling:touch}
  thead, tbody, tr{width:100%}
  /* Evita que controles e textos "estourem" */
  input, select, button, textarea{max-width:100%}

  /* Ajustes gerais para telas menores */
  @media (max-width: 720px){
    header{padding:16px 12px}
    .container{padding:12px}
    .card{padding:12px; border-radius:14px}

    /* Linhas viram colunas no mobile */
    .row.nowrap{flex-wrap:wrap}
    .row.nowrap > *{flex:1 1 140px}

    /* Ranking: permitir quebrar linha (no original estava tudo nowrap) */
    #ranking .row, #ranking .row *{white-space:normal}
    #ranking .row{gap:10px}
    #ranking .row label{flex:0 0 auto}
    #ranking .row select, #ranking .row button{flex:1 1 140px}

    /* Botões maiores e mais fáceis de tocar */
    .tab-btn{padding:10px 14px}
    button{padding:12px 14px}

    /* Banner do placar: textos menores no celular */
    .match-center .teams{font-size:22px}
    .match-center .score{font-size:26px}
    .players-line{font-size:13px}
  }

  @media (min-width: 721px){
    /* Desktop: volta o comportamento original do ranking (mais compacto) */
    #ranking .row, #ranking .row *{white-space:nowrap}
  }


  
  @media (max-width: 720px){
    .match-center .teams{font-size:20px}
    .match-center .score{font-size:24px}
    .winner-badge{padding:5px 10px; font-size:13px}
    .players-line{font-size:12px}
  }

  @media (min-width: 721px){
    }


  /* ===== Ajuste global do Placar (desktop + mobile) ===== */
  /* Tipografia mais equilibrada */
  .match-center .teams{font-size:24px}
  .match-center .score{font-size:28px}
  .players-line{font-size:13px}

  /* Desktop grande: ainda um pouco maior, mas sem exagero */
  @media (min-width: 1100px){
    .match-center .teams{font-size:26px}
    .match-center .score{font-size:30px}
  }

  /* Mobile: mantém compacto */
  @media (max-width: 720px){
    .match-center .teams{font-size:20px}
    .match-center .score{font-size:24px}
    .players-line{font-size:12px}
  }


  
  /* Desktop grande */
  @media (min-width: 1100px){
    }

  /* Mobile */
  @media (max-width: 720px){
    .match-center .teams{font-size:18px}
    .match-center .score{font-size:22px}
    .players-line{font-size:12px}
  }


  
  /* Desktop grande */
  @media (min-width: 1100px){
    }

  /* Mobile */
  @media (max-width: 720px){
    .match-center .teams{font-size:18px}
    .match-center .score{font-size:22px}
    .players-line{font-size:12px}
  }


  /* Desktop grande: pode aumentar um pouco sem exagero */
  @media (min-width: 1100px){
    }

  /* Mobile: reduz a largura um pouco para diminuir a altura (como é quadrado) */
  @media (max-width: 720px){
    .match-center .teams{font-size:18px}
    .match-center .score{font-size:22px}
    .players-line{font-size:12px}
    .winner-badge{font-size:13px; padding:5px 10px}
  }


  
  /* Desktop bem grande */
  @media (min-width: 1200px){
    }

  /* Mobile */
  @media (max-width: 720px){
    .match-center .teams{font-size:18px}
    .match-center .score{font-size:22px}
    .players-line{font-size:12px}
    .winner-badge{font-size:13px; padding:5px 10px}
  }


  /* ===== PLACAR – QUADRADO E MAIOR (SEM FAIXA PRETA) ===== */
  .banner{
    position: relative;
    aspect-ratio: 1 / 1;
    width: 100%;
    max-width: 720px;
    margin: 0 auto;
    border-radius: 16px;
    overflow: hidden;
  }

  .banner img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  @media (max-width: 720px){
    .banner{
      max-width: 95vw;
    }
  }

</style>
</head>
<body>
<header>
  <h1>Futsal Bandula - Quarta 21h</h1>
  <div class="sub">Registros de dados com cadastro, jogadores, lançamentos, ranking, financeiro e placar da semana.</div>
  
<div class="tabs">
    <button class="tab-btn active" data-tab="ranking">Ranking</button>
    <button class="tab-btn" data-tab="placar">Placar da semana</button>
    <button class="tab-btn" data-tab="campeoes">Campeões</button>
</div>
</header>

<div class="container">

  <!-- CADASTRO -->
  <section id="cadastro" class="tab card">
    <h2>Cadastro de jogador</h2>
    <div class="row">
      <input id="playerName" placeholder="Nome do jogador">
      <select id="playerPos"><option value="linha">Linha</option><option value="goleiro">Goleiro</option></select>
      <select id="playerTipo"><option value="mensalista">Mensalista</option><option value="avulso">Avulso</option></select>
      <button class="btn primary" id="addPlayerBtn">Adicionar</button>
    </div>
    <div class="muted" style="margin-top:10px">Valores padrão: Mensalista R$ 60,00; Avulso R$ 15,00; Goleiro é isento.</div>
    <div id="playersSummary" style="margin-top:12px"></div>
  </section>

  <!-- JOGADORES -->
  <section id="jogadores" class="tab card hidden">
    <h2>Gerenciar jogadores</h2>
    <div id="playersList"></div>
  </section>

  <!-- LANCAMENTOS -->
  <section id="lancamentos" class="tab card hidden">
    <h2>Lançamentos</h2>

    <div class="grid cols-2">
      <!-- Pontuação -->
      <section class="card">
        <h3>Pontuação</h3>
        <div class="row">
          <select id="selectPlayer"></select>
          <input id="scoreDateText" placeholder="dd/mm/aaaa" inputmode="numeric" style="width:130px">
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn positive" data-action="victoria">Vitória (+3)</button>
          <button class="btn positive" data-action="empate">Empate (+1)</button>
          <button class="btn positive" data-action="participacao_mes">Participação (mês) (+2)</button>
          <button class="btn positive" data-action="pagamento_prazo">Pagamento até 5º dia útil (+2)</button>
          <button class="btn negative" data-action="falta_sem_sub">Falta sem substituto (-2)</button>
          <button class="btn negative" data-action="pagamento_atraso">Pagamento em atraso (−2 a cada 3 dias)</button>
        </div>
        <div class="row" style="margin-top:8px; width:100%">
          <input id="scoreNote" placeholder="Observação (opcional)" style="flex:1">
          <button class="btn" id="undoLast">Desfazer último lançamento</button>
        </div>

        <h4 style="margin-top:12px">Histórico de pontuação</h4>
        <div class="row small" style="align-items:center">
          <label>Modo</label>
          <select id="histScoreMode">
            <option value="mensal">Mensal</option>
            <option value="anual">Anual</option>
            <option value="total">Total</option>
          </select>
          <span id="histScoreMonthWrap">
            <label>Mês</label><select id="histScoreMonth"></select>
          </span>
          <span id="histScoreYearWrap">
            <label>Ano</label><select id="histScoreYear"></select>
          </span>
          <button class="btn" id="applyScoreFilter">Filtrar</button>
        </div>
        <div style="max-height:250px; overflow:auto; margin-top:6px">
          <table id="historyScoreTable">
            <thead><tr><th>Data</th><th>Jogador</th><th>Ação</th><th class="right">Pontos</th><th>Obs.</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Financeiro -->
      <section class="card">
        <h3>Lançar financeiro</h3>
        <div class="row">
          <select id="payPlayer"></select>
          <div class="split">
            <label>Mês ref.</label><select id="payMonth"></select>
            <label>Ano</label><select id="payYear"></select>
          </div>
        </div>
        <div class="row nowrap" style="margin-top:8px; width:100%">
          <input id="payAmount" inputmode="decimal" placeholder="Valor (R$ 0,00)">
          <button class="btn" id="useMensalPadrao">Usar padrão (mensalista)</button>
          <button class="btn" id="useAvulsoPadrao">Usar padrão (avulso)</button>
        </div>
        <div class="row" style="margin-top:8px; width:100%">
          <input id="payNote" placeholder="Observação (opcional)" style="flex:1">
          <button class="btn primary" id="addPayment">Registrar pagamento</button>
        </div>

        <h4 style="margin-top:14px">Pagamento da quadra</h4>
        <div class="row" style="width:100%; align-items:center">
          <label>Mês</label><select id="courtMonth"></select>
          <label>Ano</label><select id="courtYear"></select>
          <label>Sugestões:</label>
          <select id="courtSuggestion" style="min-width:240px">
            <option value="">— selecione —</option>
            <option value="480">Mês com 4 semanas — R$ 480,00</option>
            <option value="600">Mês com 5 semanas — R$ 600,00</option>
          </select>
          <button class="btn danger" id="addCourtExpense">Lançar pagamento da quadra</button>
        </div>

        <h4 style="margin-top:14px">Outras despesas</h4>
        <div class="row" style="width:100%; align-items:center">
          <label>Mês</label><select id="otherMonth"></select>
          <label>Ano</label><select id="otherYear"></select>
          <input id="otherExpDesc" placeholder="Descrição" style="flex:1">
          <input id="otherExpAmount" inputmode="decimal" placeholder="Valor (R$ 0,00)" style="width:160px">
          <button class="btn danger" id="addOtherExpense">Lançar despesa</button>
        </div>

        <h4 style="margin-top:12px">Histórico financeiro</h4>
        <div class="row small" style="align-items:center">
          <label>Modo</label>
          <select id="histFinMode">
            <option value="mensal">Mensal</option>
            <option value="anual">Anual</option>
            <option value="total">Total</option>
          </select>
          <span id="histFinMonthWrap">
            <label>Mês</label><select id="histFinMonth"></select>
          </span>
          <span id="histFinYearWrap">
            <label>Ano</label><select id="histFinYear"></select>
          </span>
          <button class="btn" id="applyFinFilter">Filtrar</button>
        </div>
        <div style="max-height:250px; overflow:auto; margin-top:6px">
          <table id="historyFinTable">
            <thead><tr><th>Data</th><th>Tipo</th><th>Jogador/Ref.</th><th class="right">Valor (R$)</th><th>Obs.</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </section>

  <!-- RANKING -->
  <section id="ranking" class="tab card hidden">
    <h2>Ranking <span class="muted">*</span></h2>
    <div class="muted small" style="margin:-6px 0 8px 0; line-height:1.5">
	  * Vitória vale <b>3</b> pontos<br>
	  * Empate vale <b>1</b> ponto<br>
	  * Participação em todos os jogos do mês vale <b>2</b> pontos<br>
	  * Falta sem arrumar nenhum substituto para o lugar perde <b>2</b> pontos<br>
	  * Pagamento até 5º dia útil vale <b>2</b> pontos<br>
	  * Pagamento em atraso retira <b>2</b> pontos a cada <b>3</b> dias de atraso<br>
	  * Apenas <b>mensalistas</b> participam do ranking
    </div>

    <div class="row nowrap">
      <label>Mês</label><select id="rankMonth"></select>
      <label>Ano</label><select id="rankYear"></select>
      <button class="btn primary" id="calcMonthly">Mensal</button>

      <label>Trimestre</label><select id="rankQuarter">
        <option value="1">Jan–Mar</option><option value="2">Abr–Jun</option>
        <option value="3">Jul–Set</option><option value="4">Out–Dez</option>
      </select>
      <button class="btn primary" id="calcQuarter">Trimestral</button>

      <label>Semestre</label><select id="rankSemester">
        <option value="1">Jan–Jun</option><option value="2">Jul–Dez</option>
      </select>
      <button class="btn primary" id="calcSemester">Semestral</button>

      <label>Ano</label><select id="rankYearOnly"></select>
      <button class="btn primary" id="calcAnnual">Anual</button>
    </div>

    <div class="row" style="justify-content:flex-end; gap:8px; margin-top:8px">
      <button class="btn" id="saveRankImg">Salvar imagem</button>
    </div>
    <div id="rankOutput" style="margin-top:10px"></div>
  </section>

  <!-- FINANCEIRO -->
  <section id="financeiro" class="tab card hidden">
    <h2>Financeiro</h2>

    <section class="card">
      <h3>Mensalistas</h3>
      <div class="row small" style="align-items:center">
        <label>Modo</label>
        <select id="finMensMode">
          <option value="anual">Anual</option>
          <option value="mensal">Mensal</option>
        </select>
        <span id="finMensMonthWrap">
          <label>Mês</label><select id="finMensMonth"></select>
        </span>
        <span id="finMensYearWrap">
          <label>Ano</label><select id="finYearSel"></select>
        </span>
        <button class="btn" id="refreshMensalistas">Atualizar</button>
        <button class="btn" id="saveMensalistasImg">Salvar imagem</button>
        <div class="legend"><span><span class="dot paid"></span> Pago</span><span><span class="dot unpaid"></span> Em aberto</span></div>
      </div>
      <div style="margin-top:8px; overflow:auto">
        <table id="mensalistasTable"><thead></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card">
      <h3>Fluxo de caixa</h3>
      <div class="row small" style="align-items:center">
        <label>Modo</label>
        <select id="cashMode">
          <option value="mensal">Mensal</option>
          <option value="anual">Anual</option>
          <option value="total">Total</option>
        </select>
        <span id="cashMonthWrap">
          <label>Mês</label><select id="cashMonth"></select>
        </span>
        <span id="cashYearWrap">
          <label>Ano</label><select id="cashYear"></select>
        </span>
        <button class="btn" id="calcCash">Atualizar</button>
        <button class="btn" id="saveCashImg">Salvar imagem</button>
      </div>
      <div id="cashSummary" style="margin-top:8px"></div>
    </section>
  </section>

  <section id="placar" class="tab card hidden">
    <h2>Placar da semana</h2>
    <div class="grid cols-2">
      <section class="card">
        <h3>Novo placar</h3>
        <!-- 1ª linha: Data, Time A, Time B (mesma linha) -->
        <div class="row nowrap">
          <input id="matchDateText" placeholder="dd/mm/aaaa" inputmode="numeric" style="width:130px">
          <input id="teamA" placeholder="Time A">
          <input id="teamB" placeholder="Time B">
        </div>
        <!-- 2ª linha: Cores -->
        <div class="row" style="margin-top:8px; align-items:center">
          <label>Cor Time A</label><input id="colorA" type="color" value="#60a5fa" style="width:60px;height:38px;padding:0">
          <label>Cor Time B</label><input id="colorB" type="color" value="#fca5a5" style="width:60px;height:38px;padding:0">
        </div>
        <!-- 3ª linha: Gols + Vencedor + Foto + Salvar -->
        <div class="row" style="margin-top:8px; align-items:center">
          <label>Gols A</label><input id="goalsA" type="number" min="0" step="1" value="0" style="width:90px">
          <label>Gols B</label><input id="goalsB" type="number" min="0" step="1" value="0" style="width:90px">
          <label>Vencedor</label>
          <select id="winnerSel"><option value="A">Time A</option><option value="B">Time B</option><option value="empate">Empate</option></select>
          <input id="photoInput" type="file" accept="image/*">
          <button class="btn" id="clearPhoto">Remover foto</button>
          <button class="btn primary" id="saveMatch">Salvar placar</button>
        </div>

        <div class="grid" style="grid-template-columns:1fr 1fr; gap:8px; margin-top:8px">
          <div>
            <label class="small muted">Jogadores Time A</label>
            <input id="searchA" placeholder="Pesquisar jogador A" class="small" style="width:100%; margin:4px 0 6px 0">
            <select multiple id="playersA" size="8" style="width:100%"></select>
          </div>
          <div>
            <label class="small muted">Jogadores Time B</label>
            <input id="searchB" placeholder="Pesquisar jogador B" class="small" style="width:100%; margin:4px 0 6px 0">
            <select multiple id="playersB" size="8" style="width:100%"></select>
          </div>
        </div>
        <div id="photoPreviewWrap" class="hidden" style="margin-top:8px">
          <img id="photoPreview" alt="Foto da semana" style="max-width:100%; border:1px solid var(--border); border-radius:12px;">
        </div>
      </section>

      <section class="card">
        <h3>Histórico da semana</h3>
        <div class="row small" style="align-items:center">
          <label>Ano</label><select id="matchesYear"></select>
          <label>Mês</label><select id="matchesMonth"></select>
          <label>Dia</label><select id="matchesDay"></select>
          <button class="btn" id="applyMatchesFilter">Filtrar</button>
        </div>
        <div class="row small" style="align-items:center; margin-top:6px">
          <label>Partida</label><select id="matchesPick" style="min-width:240px"></select>
          <button class="btn" id="editSelected">Editar placar</button>
          <button class="btn" id="saveMatchImg">Salvar imagem do placar</button>
          <button class="btn danger" id="deleteSelected">Excluir partida</button>
        </div>
        <div id="matchesList" class="grid" style="grid-template-columns:1fr; gap:12px; margin-top:8px"></div>
      </section>
    </div>
  </section>


  <!-- CAMPEÕES -->
<section id="campeoes" class="tab card hidden">
    <h2>Campeões</h2>

    <div class="grid cols-2">
      <section class="card">
        <h3>Novo campeão</h3>
        <div class="row nowrap">
          <label>Ano</label><select id="champYear"></select>
          <label>Modo</label>
          <select id="champMode">
			<option value="mvp">Melhor da partida</option>
            <option value="mensal">Mensal</option>
            <option value="trimestral">Trimestral</option>
            <option value="semestral">Semestral</option>
            <option value="anual">Anual</option>
          </select>
          <span id="champPeriodWrap" class="split">
            <label id="champPeriodLabel">Período</label>
            <select id="champPeriod"></select>
          </span>
        </div>
        <div class="row" style="margin-top:8px; align-items:center">
          <label>Jogador</label><select id="champPlayer" style="flex:1"></select>
        </div>
        <div class="row" style="margin-top:8px; align-items:center">
          <input id="champPhotoInput" type="file" accept="image/*">
          <button class="btn" id="champClearPhoto">Remover foto</button>
        </div>
        <div class="row" style="margin-top:12px">
            <button class="btn primary" id="champSave" style="width:100%">Salvar campeão</button>
        </div>
        <div id="champPhotoPreviewWrap" class="hidden" style="margin-top:8px">
          <img id="champPhotoPreview" alt="Foto do campeão" style="max-width:100%; border:1px solid var(--border); border-radius:12px;">
        </div>
      </section>

      <section class="card">
        <h3>Histórico de campeões</h3>

        <div class="row small" style="align-items:center">
          <label>Ano</label><select id="champHistYear"></select>
          <label>Modo</label>
          <select id="champHistMode">
            <option value="">Todos</option>
			<option value="mvp">Melhor da partida</option>
            <option value="mensal">Mensal</option>
            <option value="trimestral">Trimestral</option>
            <option value="semestral">Semestral</option>
            <option value="anual">Anual</option>
          </select>
          <span id="champHistPeriodWrap" class="split">
            <label id="champHistPeriodLabel">Período</label>
            <select id="champHistPeriod"></select>
          </span>
        </div>
        
        <div class="row small" style="align-items:center; margin-top:12px">
          <label>Campeão</label><select id="champPick" style="width:100%"></select>
        </div>

        <div class="row small" style="margin-top:6px">
             <button class="btn" id="applyChampFilter" style="width:100%">Filtrar</button>
        </div>

        <div class="row" style="margin-top:8px; justify-content:center">
          <button class="btn" id="editChampion">Editar campeão</button>
          <button class="btn" id="saveChampionImg">Salvar imagem do campeão</button>
          <button class="btn danger" id="deleteChampion">Excluir campeão</button>
        </div>

        <div id="championsList" class="grid" style="grid-template-columns:1fr; gap:12px; margin-top:8px"></div>
      </section>
    </div>
  </section>


  <!-- BACKUP -->
  <section id="backup" class="tab card hidden">
    <h2>Backup & Dados</h2>
    <div class="row">
      <button class="btn primary" id="exportBtn">Exportar JSON</button>
      <input id="importFile" type="file" accept="application/json">
      <button class="btn" id="importBtn">Importar JSON</button>
    </div>
    <div class="muted" style="margin-top:8px">Os dados ficam salvos no navegador (localStorage) em <b>futsalData:v1</b>.</div>
  </section>

</div>

<script>
(function(){
  const $$ = (sel, root=document)=>root.querySelector(sel);
  const $$$ = (sel, root=document)=>root.querySelectorAll(sel);
  const $id = (id)=>document.getElementById(id);

  const STORAGE_KEY = 'futsalData:v1';
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { players:[], entries:[], payments:[], expenses:[], matches:[], champions:[], lastEntryId:null };
      const d = JSON.parse(raw);
      d.players??=[]; d.entries??=[]; d.payments??=[]; d.expenses??=[]; d.matches??=[]; d.champions??=[];
      return d;
    }catch(e){ return { players:[], entries:[], payments:[], expenses:[], matches:[], champions:[], lastEntryId:null }; }
  }
  let state = load();
  function save(){
    if(PUBLIC_MODE){
      // modo público: não gravar nada no navegador do visitante
      refreshUI();
      return;
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    refreshUI();
  }

  const nowISO=()=>new Date().toISOString();
  const pad2=n=>String(n).padStart(2,'0');
  const fmtMoney=v=>'R$ '+ new Intl.NumberFormat('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}).format(Number(v||0));
  function parseMoneyBR(str){
    if(str==null) return 0;
    const s=String(str).trim().replace(/\./g,'').replace(',','.');
    const n = Number(s);
    return Number.isFinite(n)?n:0;
  }
  const monthName=i=>['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][i];
  const fullMonth=i=>['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'][i];
  const toISODateUTCNoon = (d)=> new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0)).toISOString();
  function fmtBr(iso){ const d=new Date(iso); if(Number.isNaN(d.getTime())) return iso; return pad2(d.getDate())+'/'+pad2(d.getMonth()+1)+'/'+d.getFullYear(); }
  function parseBr(str){ const m=(str||'').match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(!m) return null; const [_,dd,mm,yyyy]=m; const d=new Date(Number(yyyy),Number(mm)-1,Number(dd)); return Number.isNaN(d.getTime())?null:d; }
  function qRange(y,q){ const map={1:[0,2],2:[3,5],3:[6,8],4:[9,11]}; const [m0,m1]=map[q]; return [new Date(Date.UTC(y,m0,1)), new Date(Date.UTC(y,m1+1,1))]; }
  function sRange(y,s){ return s===1 ? [new Date(Date.UTC(y,0,1)), new Date(Date.UTC(y,6,1))] : [new Date(Date.UTC(y,6,1)), new Date(Date.UTC(y,12,1))]; }
  const inRange=(iso,a,b)=>{ const t=new Date(iso).getTime(); return t>=a.getTime() && t<b.getTime(); };

  function baseDue(p){ return p?.position==='goleiro' ? 0 : (p?.tipo==='mensalista'?60:15); }
  function monthlyDueFor(p, m, y){
    if(y<2025 || (y===2025 && m<=7)) return 0;
    return baseDue(p);
  }  // ===== MODO PÚBLICO (somente visualização)
  const PUBLIC_MODE = true; // público sempre (somente leitura)

  // No modo público, lê os dados do arquivo data21h.json (publicado junto do site)
  async function loadFromPublicJSON(){
    try{
      const res = await fetch('./data21.json', { cache: 'no-store' })
      if(!res.ok) throw new Error('HTTP '+res.status);
      const d = await res.json();
      state = { players:[], entries:[], payments:[], expenses:[], matches:[], champions:[], lastEntryId:null, ...d };
    }catch(err){
      console.warn('Não foi possível carregar data21h.json; usando dados do localStorage deste navegador.', err);
    }
  }

  function setActiveTab(tabId){
    // simula o clique sem depender do usuário
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
    document.querySelectorAll('.tab').forEach(p => p.classList.toggle('hidden', p.id !== tabId));
  }

  function applyPublicMode(){
    // 1) Permitir apenas essas abas
    const ALLOWED_TABS = new Set(['ranking', 'placar', 'campeoes']);
    const BLOCKED_TABS = ['cadastro','jogadores','lancamentos','financeiro','backup'];

    // Esconde botões das abas bloqueadas
    document.querySelectorAll('.tab-btn').forEach(btn => {
      const tab = btn.dataset.tab;
      if (!ALLOWED_TABS.has(tab)) btn.style.display = 'none';
    });

    // Garante que não dá pra abrir aba bloqueada clicando/chamando handler
    // (seu código atual abre a aba no click; então a gente intercepta)
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (!ALLOWED_TABS.has(btn.dataset.tab)) {
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);
    });

    // 2) Na aba PLACAR: esconder "Novo placar" (primeiro card da grid)
    const placarSection = document.getElementById('placar');
    if (placarSection) {
      const grid = placarSection.querySelector('.grid.cols-2');
      const cards = grid ? Array.from(grid.querySelectorAll(':scope > section.card')) : [];
      // cards[0] = Novo placar | cards[1] = Histórico da semana
      if (cards[0]) cards[0].style.display = 'none';
      if (grid) grid.style.gridTemplateColumns = '1fr'; // ocupa a largura toda
    }

	// 2b) Na aba CAMPEÕES: esconder "Novo campeão" (primeiro card da grid)
	const campeoesSection = document.getElementById('campeoes');
	if (campeoesSection) {
	  const gridC = campeoesSection.querySelector('.grid.cols-2');
	  const cardsC = gridC ? Array.from(gridC.querySelectorAll(':scope > section.card')) : [];
	  // cardsC[0] = Novo campeão | cardsC[1] = Histórico de campeões
	  if (cardsC[0]) cardsC[0].style.display = 'none';
	  if (gridC) gridC.style.gridTemplateColumns = '1fr';
	}

	// 3) No Histórico do PLACAR: esconder botões de edição/exclusão
	const btnEdit = document.getElementById('editSelected');
	const btnDel  = document.getElementById('deleteSelected');
	if (btnEdit) btnEdit.style.display = 'none';
	if (btnDel)  btnDel.style.display  = 'none';
	const btnEditChamp = document.getElementById('editChampion');
	const btnDelChamp  = document.getElementById('deleteChampion');
	const btnSaveChampImg = document.getElementById('saveChampionImg')
	if (btnEditChamp) btnEditChamp.style.display = 'none';
	if (btnDelChamp)  btnDelChamp.style.display  = 'none';

    // 4) Entrar já no Ranking (ou Placar, se preferir)
    setActiveTab('ranking');
  }

  if (PUBLIC_MODE) {
    applyPublicMode();
  }

// ===== Exportar um nó HTML como PNG idêntico ao que se vê (inlining de estilos)
async function exportNodeAsPNG(node, filename = 'export.png', scale = Math.max(2, Math.ceil(window.devicePixelRatio || 2))) {
  if (!node) return;

  // Clona o nó e inlina TODOS os estilos computados (evita perdas de CSS externas/CORS)
  const cloneDeep = node.cloneNode(true);
  const inlineStyles = (src, dst) => {
    const cs = getComputedStyle(src);
    const styleStr = Array.from(cs).map(p => `${p}:${cs.getPropertyValue(p)}`).join(';');
    dst.setAttribute('style', `${styleStr};${dst.getAttribute('style')||''}`);
    const sKids = Array.from(src.children);
    const dKids = Array.from(dst.children);
    for (let i = 0; i < sKids.length; i++) inlineStyles(sKids[i], dKids[i]);
  };
  inlineStyles(node, cloneDeep);

  // Usa as dimensões reais do conteúdo (inclusive tabelas com overflow)
  const w = Math.ceil(node.scrollWidth || node.offsetWidth || 320);
  const h = Math.ceil(node.scrollHeight || node.offsetHeight || 200);

  // Wrapper com fundo igual ao da página para preservar o "look"
  const wrap = document.createElement('div');
  wrap.setAttribute('xmlns', 'http://www.w3.org/1999/xhtml');
  const bodyBg = getComputedStyle(document.body).background || getComputedStyle(document.body).backgroundColor || '#0b1020';
  wrap.setAttribute('style', `margin:0;padding:0;background:${bodyBg};-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;`);
  wrap.appendChild(cloneDeep);

  const xhtml = new XMLSerializer().serializeToString(wrap);
  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${w*scale}" height="${h*scale}">
      <foreignObject x="0" y="0" width="${w}" height="${h}" transform="scale(${scale})">
        ${xhtml}
      </foreignObject>
    </svg>
  `;

  // Rasteriza o SVG em canvas com alta qualidade
  const img = new Image();
  img.decoding = 'async';
  img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
  await new Promise(res => { img.onload = res; });

  const canvas = document.createElement('canvas');
  canvas.width = w * scale;
  canvas.height = h * scale;
  const ctx = canvas.getContext('2d', { alpha: false });
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(img, 0, 0);

  canvas.toBlob(blob => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }, 'image/png', 1);
}

  const tabBtns = $$$('.tab-btn'); const panels = $$$('.tab');
  tabBtns.forEach(btn=>{
    btn.addEventListener('click',()=>{
      tabBtns.forEach(b=>b.classList.remove('active'));
      panels.forEach(p=>p.classList.add('hidden'));
      btn.classList.add('active');
      const panel = $id(btn.dataset.tab); if(panel) panel.classList.remove('hidden');
    });
  });

  const playerName=$id('playerName'), playerPos=$id('playerPos'), playerTipo=$id('playerTipo'), addPlayerBtn=$id('addPlayerBtn');
  const playersSummary=$id('playersSummary'), playersList=$id('playersList');

  const selectPlayer=$id('selectPlayer'), scoreDateText=$id('scoreDateText'), scoreNote=$id('scoreNote'), undoLast=$id('undoLast');
  const histScoreMode=$id('histScoreMode'), histScoreMonthWrap=$id('histScoreMonthWrap'), histScoreYearWrap=$id('histScoreYearWrap'), histScoreMonth=$id('histScoreMonth'), histScoreYear=$id('histScoreYear'), applyScoreFilter=$id('applyScoreFilter'), historyScoreTable=$id('historyScoreTable').querySelector('tbody');

  const payPlayer=$id('payPlayer'), payMonth=$id('payMonth'), payYear=$id('payYear'), payAmount=$id('payAmount'), payNote=$id('payNote');
  const useMensalPadrao=$id('useMensalPadrao'), useAvulsoPadrao=$id('useAvulsoPadrao'), addPayment=$id('addPayment');
  const courtMonth=$id('courtMonth'), courtYear=$id('courtYear'), courtSuggestion=$id('courtSuggestion'), addCourtExpense=$id('addCourtExpense');
  const otherMonth=$id('otherMonth'), otherYear=$id('otherYear'), otherExpDesc=$id('otherExpDesc'), otherExpAmount=$id('otherExpAmount'), addOtherExpense=$id('addOtherExpense');

  const histFinMode=$id('histFinMode'), histFinMonthWrap=$id('histFinMonthWrap'), histFinYearWrap=$id('histFinYearWrap'), histFinMonth=$id('histFinMonth'), histFinYear=$id('histFinYear'), applyFinFilter=$id('applyFinFilter'), historyFinTable=$id('historyFinTable').querySelector('tbody');

  const rankMonth=$id('rankMonth'), rankYear=$id('rankYear'), rankQuarter=$id('rankQuarter'), rankSemester=$id('rankSemester'), rankYearOnly=$id('rankYearOnly');
  const calcMonthly=$id('calcMonthly'), calcQuarter=$id('calcQuarter'), calcSemester=$id('calcSemester'), calcAnnual=$id('calcAnnual'), rankOutput=$id('rankOutput');
  const saveRankImg=$id('saveRankImg');

  const finYearSel=$id('finYearSel'), mensalistasTable=$id('mensalistasTable');
  const finMensMode=$id('finMensMode'), finMensMonth=$id('finMensMonth'), finMensMonthWrap=$id('finMensMonthWrap'), finMensYearWrap=$id('finMensYearWrap');
  const refreshMensalistas=$id('refreshMensalistas'), saveMensalistasImg=$id('saveMensalistasImg');

  const cashMode=$id('cashMode'), cashMonth=$id('cashMonth'), cashMonthWrap=$id('cashMonthWrap'), cashYearWrap=$id('cashYearWrap'), cashYear=$id('cashYear'), calcCash=$id('calcCash'), cashSummary=$id('cashSummary');
  const saveCashImg=$id('saveCashImg');

  const matchDateText=$id('matchDateText'), teamA=$id('teamA'), teamB=$id('teamB'), colorA=$id('colorA'), colorB=$id('colorB'), goalsA=$id('goalsA'), goalsB=$id('goalsB'), winnerSel=$id('winnerSel');
  const playersA=$id('playersA'), playersB=$id('playersB'), photoInput=$id('photoInput'), clearPhoto=$id('clearPhoto'), photoPreview=$id('photoPreview'), photoPreviewWrap=$id('photoPreviewWrap'), saveMatch=$id('saveMatch');
  const searchA=$id('searchA'), searchB=$id('searchB');
  const matchesYear=$id('matchesYear'), matchesMonth=$id('matchesMonth'), matchesDay=$id('matchesDay'), matchesPick=$id('matchesPick'), applyMatchesFilter=$id('applyMatchesFilter'), editSelected=$id('editSelected'), deleteSelected=$id('deleteSelected'), matchesList=$id('matchesList');
  const saveMatchImg=$id('saveMatchImg');


  // ===== Campeões (visualização)
  const champHistYear=$id('champHistYear'), champHistMode=$id('champHistMode'), champHistPeriodWrap=$id('champHistPeriodWrap'), champHistPeriodLabel=$id('champHistPeriodLabel'), champHistPeriod=$id('champHistPeriod');
  const applyChampFilter=$id('applyChampFilter'), champPick=$id('champPick'), championsList=$id('championsList');
  const saveChampionImg=$id('saveChampionImg');
  const exportBtn=$id('exportBtn'), importFile=$id('importFile'), importBtn=$id('importBtn');

  function validYearsFromSet(set){
    return Array.from(set).filter(y=>Number.isFinite(y) && y>=2000).sort((a,b)=>a-b);
  }

  function renderPlayersSummary(){
    if(!state.players.length){ playersSummary.innerHTML='<div class="muted">Nenhum jogador cadastrado.</div>'; return; }
    playersSummary.innerHTML = `
      <table>
        <thead><tr><th>Jogador</th><th>Posição</th><th>Tipo</th><th class="right">Valor padrão</th></tr></thead>
        <tbody>
          ${state.players.slice().sort((a,b)=>a.name.localeCompare(b.name,'pt-BR')).map(p=>`
            <tr>
              <td>${p.name}${p.active===false?' <span class="muted">(inativo)</span>':''}</td>
              <td>${p.position==='goleiro'?'Goleiro':'Linha'}</td>
              <td>${p.tipo==='mensalista'?'Mensalista':'Avulso'}</td>
              <td class="right">${fmtMoney(baseDue(p))}</td>
            </tr>`).join('')}
        </tbody>
      </table>`;
  }
  function renderPlayersEditor(){
    playersList.innerHTML = state.players.length
      ? state.players.slice().sort((a,b)=>a.name.localeCompare(b.name,'pt-BR')).map(p=>`
        <div class="row" style="justify-content:space-between; align-items:center; margin:6px 0; padding:8px; border:1px solid var(--border); border-radius:10px">
          <div class="row" style="align-items:center; gap:6px">
            <span class="pill">${p.name}</span>
            <span class="pill">${p.position==='goleiro'?'goleiro':'linha'}</span>
            <span class="pill">${p.tipo==='mensalista'?'mensalista':'avulso'}</span>
            ${p.active===false?'<span class="pill muted">inativo</span>':''}
          </div>
          <div class="row" style="gap:6px">
            <select data-ppos="${p.id}"><option value="linha" ${p.position!=='goleiro'?'selected':''}>Linha</option><option value="goleiro" ${p.position==='goleiro'?'selected':''}>Goleiro</option></select>
            <select data-ptipo="${p.id}"><option value="mensalista" ${p.tipo==='mensalista'?'selected':''}>Mensalista</option><option value="avulso" ${p.tipo!=='mensalista'?'selected':''}>Avulso</option></select>
            <button data-ptgl="${p.id}">${p.active===false?'Ativar':'Desativar'}</button>
            <button class="btn danger" data-prm="${p.id}">Remover</button>
          </div>
        </div>`).join('')
      : '<div class="muted">Nenhum jogador cadastrado.</div>';

    $$$('[data-ppos]').forEach(s=>s.onchange=e=>{ const p=state.players.find(pp=>pp.id===s.getAttribute('data-ppos')); if(p){ p.position=e.target.value; save(); }});
    $$$('[data-ptipo]').forEach(s=>s.onchange=e=>{ const p=state.players.find(pp=>pp.id===s.getAttribute('data-ptipo')); if(p){ p.tipo=e.target.value; save(); }});
    $$$('[data-ptgl]').forEach(b=>b.onclick=()=>{ const p=state.players.find(pp=>pp.id===b.getAttribute('data-ptgl')); if(p){ p.active=p.active===false?true:false; save(); }});
    $$$('[data-prm]').forEach(b=>b.onclick=()=>{
      const id=b.getAttribute('data-prm');
      if(!confirm('Remover definitivamente este jogador e todo o seu histórico?')) return;
      state.entries = state.entries.filter(e=>e.player_id!==id);
      state.payments = state.payments.filter(p=>p.player_id!==id);
      state.matches.forEach(m=>{
        m.playersA = (m.playersA||[]).filter(pid=>pid!==id);
        m.playersB = (m.playersB||[]).filter(pid=>pid!==id);
      });
      state.players = state.players.filter(p=>p.id!==id);
      save();
    });
  }
  addPlayerBtn.onclick=()=>{
    const name=(playerName.value||'').trim(); if(!name){ alert('Informe o nome'); return; }
    if(state.players.some(p=>p.name.trim().toLowerCase()===name.toLowerCase())){ alert('Já existe jogador com esse nome'); return; }
    const pos=playerPos.value; const tipo=playerTipo.value;
    state.players.push({ id:'id_'+Math.random().toString(36).slice(2)+Date.now().toString(36), name, position:pos, tipo, active:true, created_at:nowISO() });
    playerName.value=''; playerPos.value='linha'; playerTipo.value='mensalista'; save();
  };

  function fillMonthYearSelect(selMonth, selYear){
    selMonth.innerHTML = Array.from({length:12},(_,i)=>`<option value="${i}">${i+1} — ${fullMonth(i)}</option>`).join('');
    const years = new Set([new Date().getFullYear()] );
    state.payments.forEach(p=>years.add(p.year));
    state.expenses.forEach(e=>years.add(e.year));
    state.entries.forEach(en=>years.add(new Date(en.date).getUTCFullYear()));
    state.matches.forEach(m=>years.add(new Date(m.date).getUTCFullYear()));
    const ylist = validYearsFromSet(years);
    selYear.innerHTML = ylist.map(y=>`<option value="${y}">${y}</option>`).join('');
    selMonth.value=String(new Date().getUTCMonth()); selYear.value=String(new Date().getUTCFullYear());
  }
  function fillCommonSelectors(){
    const t=new Date(); const br=pad2(t.getDate())+'/'+pad2(t.getMonth()+1)+'/'+t.getFullYear();
    scoreDateText.value = br; matchDateText.value = br;

    fillMonthYearSelect(histScoreMonth, histScoreYear);
    fillMonthYearSelect(histFinMonth, histFinYear);
    fillMonthYearSelect(payMonth, payYear);
    fillMonthYearSelect(courtMonth, courtYear);
    fillMonthYearSelect(otherMonth, otherYear);

    // Ranking anos
    const years = new Set(Array.from($id('histScoreYear').options).map(o=>Number(o.value)));
    const yopts = validYearsFromSet(years).map(y=>`<option value="${y}">${y}</option>`).join('');
    rankMonth.innerHTML = histScoreMonth.innerHTML;
    rankYear.innerHTML=yopts; rankYearOnly.innerHTML=yopts;
    rankMonth.value=String(new Date().getUTCMonth()); rankYear.value=String(new Date().getUTCFullYear()); rankYearOnly.value=String(new Date().getUTCFullYear());

    finYearSel.innerHTML = yopts;
    finYearSel.value=String(new Date().getUTCFullYear());

    cashMonth.innerHTML = histScoreMonth.innerHTML;
    cashYear.innerHTML  = yopts;
    cashMonth.value=String(new Date().getUTCMonth()); cashYear.value=String(new Date().getUTCFullYear());

    // Mensalistas (modo mensal/anual)
    finMensMonth.innerHTML = histScoreMonth.innerHTML;
    finMensMonth.value = String(new Date().getUTCMonth());
    finMensMode.value = 'anual';
    finMensMonthWrap.style.display = 'none';
  }

  function renderPlayerSelects(){
    const qA = (searchA?.value||'').toLowerCase();
    const qB = (searchB?.value||'').toLowerCase();
    const all = state.players.slice().sort((a,b)=>a.name.localeCompare(b.name,'pt-BR'));

    const needRebuild =
      !playersA.dataset.full || playersA.options.length !== all.length ||
      !playersB.dataset.full || playersB.options.length !== all.length;

    if(needRebuild){
      const mk = p=>`<option value="${p.id}" ${p.active===false?'disabled':''}>${p.name}${p.active===false?' (inativo)':''}</option>`;
      playersA.innerHTML = all.map(mk).join('');
      playersB.innerHTML = all.map(mk).join('');
      playersA.dataset.full = '1';
      playersB.dataset.full = '1';
    }

    const info = new Map(all.map(p=>[p.id, {name:p.name.toLowerCase(), disabled:p.active===false}]));
    Array.from(playersA.options).forEach(o=>{
      const meta = info.get(o.value);
      const name = meta?.name || (o.textContent||'').toLowerCase();
      o.hidden   = qA && !name.includes(qA);
      if(meta) o.disabled = meta.disabled;
    });
    Array.from(playersB.options).forEach(o=>{
      const meta = info.get(o.value);
      const name = meta?.name || (o.textContent||'').toLowerCase();
      o.hidden   = qB && !name.includes(qB);
      if(meta) o.disabled = meta.disabled;
    });

    const singleOpts = all.map(p=>`<option value="${p.id}" ${p.active===false?'disabled':''}>${p.name}${p.active===false?' (inativo)':''}</option>`).join('');
    if($id('selectPlayer')) $id('selectPlayer').innerHTML = '<option value="">— jogador —</option>'+singleOpts;
    if($id('payPlayer'))    $id('payPlayer').innerHTML    = '<option value="">— jogador —</option>'+singleOpts;
  }

  const ACTIONS={
    victoria:{label:'Vitória',points:3},
    empate:{label:'Empate',points:1},
    participacao_mes:{label:'Participação (mês)',points:2},
    pagamento_prazo:{label:'Pagamento até 5º dia útil',points:2},
    falta_sem_sub:{label:'Falta sem substituto',points:-2},
    pagamento_atraso:{label:'Pagamento em atraso',dynamic:true}
  };
  function addEntry(actionKey){
    const pid=selectPlayer.value; if(!pid){ alert('Selecione um jogador'); return; }
    const d = parseBr(scoreDateText.value); if(!d){ alert('Informe a data em dd/mm/aaaa'); return; }
    const iso = toISODateUTCNoon(d);
    const act=ACTIONS[actionKey]; if(!act) return;
    let points=act.points||0; let meta={};
    if(act.dynamic){ const days=Number(prompt('Dias de atraso (inteiro):','3')); const n=Math.max(0,Math.floor(days)); const blocks=Math.ceil(n/3); points=-2*blocks; meta={days_late:n,blocks}; }
    const entry={ id:'id_'+Math.random().toString(36).slice(2), player_id:pid, action:actionKey, points, note:(scoreNote.value||'').trim(), date:iso, created_at:nowISO(), meta };
    state.entries.push(entry); state.lastEntryId=entry.id; scoreNote.value=''; save();
  }
  $$$('button[data-action]').forEach(b=>b.addEventListener('click',()=>addEntry(b.dataset.action)));
  undoLast.onclick=()=>{
    const id=state.lastEntryId; if(!id){ alert('Nada para desfazer'); return; }
    const i=state.entries.findIndex(e=>e.id===id);
    if(i>=0){ state.entries.splice(i,1); state.lastEntryId=null; save(); }
  };

  // ===== Histórico de Pontuação (Modo Mensal/Anual/Total)
  function renderHistoryScore(){
    const mode = histScoreMode.value;
    const m=Number(histScoreMonth.value), y=Number(histScoreYear.value);
    let rows = state.entries.slice();
    if(mode==='mensal'){
      rows = rows.filter(e=>{ const d=new Date(e.date); return d.getUTCFullYear()===y && d.getUTCMonth()===m; });
    }else if(mode==='anual'){
      rows = rows.filter(e=> new Date(e.date).getUTCFullYear()===y);
    }
    rows.sort((a,b)=> new Date(b.date)-new Date(a.date) || (b.created_at||'').localeCompare(a.created_at||''));
    historyScoreTable.innerHTML = rows.map(e=>{
      const p=state.players.find(pp=>pp.id===e.player_id);
      const lbl=ACTIONS[e.action]?.label||e.action;
      const meta=e.action==='pagamento_atraso'&&e.meta?` (${e.meta.days_late}d atraso)`:''; const pts=Number(e.points||0);
      return `<tr><td>${fmtBr(e.date)}</td><td>${p?p.name:'(removido)'}</td><td>${lbl}${meta}</td><td class="right">${pts>0?'+':''}${pts}</td><td class="muted">${e.note||''}</td><td class="right"><button class="btn danger" data-del="${e.id}">Excluir</button></td></tr>`;
    }).join('') || '<tr><td colspan="6" class="muted">Sem lançamentos</td></tr>';
    $$$('#historyScoreTable [data-del]').forEach(b=>b.onclick=()=>{ const id=b.getAttribute('data-del'); const i=state.entries.findIndex(e=>e.id===id); if(i>=0 && confirm('Excluir este lançamento?')){ state.entries.splice(i,1); save(); }});
    histScoreMonthWrap.style.display = mode==='mensal' ? 'inline-flex' : 'none';
    histScoreYearWrap.style.display  = mode==='total' ? 'none' : 'inline-flex';
  }
  histScoreMode.onchange=renderHistoryScore;
  applyScoreFilter.onclick=renderHistoryScore;

  // ===== Histórico Financeiro (Modo Mensal/Anual/Total)
  function renderHistoryFin(){
    const mode=histFinMode.value;
    const m=Number(histFinMonth.value), y=Number(histFinYear.value);
    let pays = state.payments.slice();
    let exps = state.expenses.slice();

    const matchPeriod = (obj)=> {
      const Y = obj.year;
      const M = obj.month;
      if(mode==='mensal') return Y===y && M===m;
      if(mode==='anual')  return Y===y;
      return true;
    };

    const rows = [
      ...pays.filter(p=>matchPeriod(p)).map(p=>({type:(state.players.find(pp=>pp.id===p.player_id)?.tipo)==='mensalista'?'Pagamento (mensalista)':'Pagamento (avulso)', date:p.created_at, who: (state.players.find(pp=>pp.id===p.player_id)?.name)||'(removido)', amount: Number(p.amount||0), note:p.note||'', id:p.id, kind:'pay'})),
      ...exps.filter(ex=>matchPeriod(ex)).map(ex=>{
        const isQuadra = (ex.kind||'')==='quadra' || /quadra/i.test(ex.note||'');
        return ({type:isQuadra?'Despesa (quadra)':'Despesa (outras)', date:ex.created_at, who: `${fullMonth(ex.month)} / ${ex.year}`, amount: -Math.abs(Number(ex.amount||0)), note:ex.note||'', id:ex.id, kind:isQuadra?'expq':'expo'});
      })
    ].sort((a,b)=> new Date(b.date)-new Date(a.date));

    historyFinTable.innerHTML = rows.map(r=>`
      <tr><td>${fmtBr(r.date)}</td><td>${r.type}</td><td>${r.who}</td>
      <td class="right">${fmtMoney(r.amount)}</td><td class="muted">${r.note}</td>
      <td class="right"><button class="btn danger" data-del="${r.kind}:${r.id}">Excluir</button></td></tr>
    `).join('') || '<tr><td colspan="6" class="muted">Sem lançamentos</td></tr>';

    $$$('#historyFinTable [data-del]').forEach(b=>b.onclick=()=>{
      const [kind,id]=(b.getAttribute('data-del')||'').split(':');
      if(kind==='pay'){ const i=state.payments.findIndex(p=>p.id===id); if(i>=0 && confirm('Excluir pagamento?')){ state.payments.splice(i,1); save(); } }
      else { const i=state.expenses.findIndex(e=>e.id===id); if(i>=0 && confirm('Excluir despesa?')){ state.expenses.splice(i,1); save(); } }
    });

    histFinMonthWrap.style.display = mode==='mensal' ? 'inline-flex' : 'none';
    histFinYearWrap.style.display  = mode==='total' ? 'none' : 'inline-flex';
  }
  histFinMode.onchange=renderHistoryFin;
  applyFinFilter.onclick=renderHistoryFin;

  // ==== Pagamento com Substituir / Acrescentar / Cancelar
  useMensalPadrao.onclick=()=>{ const p=state.players.find(pp=>pp.id===payPlayer.value); payAmount.value= (p && p.position==='goleiro') ? '0,00' : '60,00'; };
  useAvulsoPadrao.onclick=()=>{ const p=state.players.find(pp=>pp.id===payPlayer.value); payAmount.value= (p && p.position==='goleiro') ? '0,00' : '15,00'; };
  addPayment.onclick=()=>{
    const pid=payPlayer.value; if(!pid){ alert('Selecione um jogador'); return; }
    const m=Number(payMonth.value), y=Number(payYear.value);
    let val = parseMoneyBR(payAmount.value);
    const pl=state.players.find(pp=>pp.id===pid);
    const due = monthlyDueFor(pl, m, y);
    if(pl?.position==='goleiro') val=0;
    if(Number.isNaN(val) || val<0){ alert('Valor inválido'); return; }

    const existing=state.payments.find(x=>x.player_id===pid && x.month===m && x.year===y);
    if(existing){
      const choice = (prompt('Já existe pagamento neste mês. Digite:\nS = Substituir\nA = Acrescentar\nC = Cancelar','A')||'').trim().toUpperCase();
      if(choice==='C') return;
      if(choice==='S'){
        existing.amount=val; existing.note=(payNote.value||''); existing.updated_at=nowISO();
      }else if(choice==='A'){
        state.payments.push({ id:'id_'+Math.random().toString(36).slice(2), player_id:pid, month:m, year:y, amount:val, note:(payNote.value||''), created_at:nowISO() });
      }else{
        alert('Opção inválida. Operação cancelada.'); return;
      }
    }else{
      state.payments.push({ id:'id_'+Math.random().toString(36).slice(2), player_id:pid, month:m, year:y, amount:val, note:(payNote.value||''), created_at:nowISO() });
    }
    payNote.value=''; save();
  };

  // Despesas
  addCourtExpense.onclick=()=>{
    const m=Number(courtMonth.value), y=Number(courtYear.value);
    const v=Number(courtSuggestion.value||0); if(!v){ alert('Selecione uma sugestão de valor'); return; }
    if(Number.isNaN(m) || Number.isNaN(y)){ alert('Selecione mês/ano da quadra.'); return; }
    state.expenses.push({ id:'id_'+Math.random().toString(36).slice(2), month:m, year:y, amount:v, note:'Pagamento da quadra', kind:'quadra', created_at:nowISO() });
    save();
  };
  addOtherExpense.onclick=()=>{
    const m=Number(otherMonth.value), y=Number(otherYear.value);
    const v=parseMoneyBR(otherExpAmount.value); if(!v){ alert('Informe o valor'); return; }
    if(Number.isNaN(m) || Number.isNaN(y)){ alert('Selecione mês/ano da despesa.'); return; }
    const desc=(otherExpDesc.value||'Despesa'); state.expenses.push({ id:'id_'+Math.random().toString(36).slice(2), month:m, year:y, amount:v, note:desc, kind:'other', created_at:nowISO() });
    otherExpAmount.value=''; otherExpDesc.value=''; save();
  };

function aggregate(list, matchesInPeriod){
  const map=new Map();

  // ✅ Pré-carrega TODOS os mensalistas (mesmo sem pontuação/jogos)
  state.players
    .filter(p => p.tipo === 'mensalista')
    .forEach(pl=>{
      map.set(pl.id,{
        total:0, v:0, emp:0, der:0, jogos:0, aprov:null,
        part:0, falta:0, prazo:0, atraso:0,
        name:pl.name, active:!!pl.active
      });
    });

  // 1) Pontos / lançamentos
  list.forEach(e=>{
    const pl = state.players.find(pp=>pp.id===e.player_id);
    if(!pl || pl.tipo!=='mensalista') return;

    const m=map.get(e.player_id); // agora sempre existe
    m.total+=Number(e.points||0);

    if(e.action==='victoria')m.v++;
    else if(e.action==='empate')m.emp++;
    else if(e.action==='participacao_mes')m.part++;
    else if(e.action==='falta_sem_sub')m.falta++;
    else if(e.action==='pagamento_prazo')m.prazo++;
    else if(e.action==='pagamento_atraso')m.atraso+=(e.meta?.blocks||0);
  });

  // 2) Jogos/Derrotas (placar)
  const matches = (matchesInPeriod||[]);
  const gamesByPlayer = new Map();

  matches.forEach(mt=>{
    const ids = new Set([...(mt.playersA||[]), ...(mt.playersB||[])]);
    ids.forEach(pid=>{
      const p = state.players.find(pp=>pp.id===pid);
      if(!p || p.tipo!=='mensalista') return;
      gamesByPlayer.set(pid, (gamesByPlayer.get(pid)||0) + 1);
    });
  });

  // Calcula jogos, derrotas e aproveitamento
  map.forEach((row,pid)=>{
    const jogos = gamesByPlayer.get(pid)||0;
    row.jogos = jogos;
    row.der = Math.max(0, jogos - (row.v||0) - (row.emp||0));

    const pts = (row.v||0)*3 + (row.emp||0);
    row.aprov = jogos>0 ? (pts/(jogos*3))*100 : null;
  });

  const rows = Array.from(map.values());
  rows.sort((a,b)=>b.total-a.total||a.name.localeCompare(b.name,'pt-BR'));
  return rows;
}

function renderRank(el, rows, title){
  if(!rows.length){ el.innerHTML='<div class="muted">Sem lançamentos no período.</div>'; return; }
  el.innerHTML = `
    <div class="row" style="justify-content:space-between; align-items:center"><span class="pill rank-chip">${title}</span></div>
    <div style="overflow:auto; margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Jogador</th>
            <th class="right">Jogos</th>
            <th class="right">Vitórias</th>
            <th class="right">Empates</th>
            <th class="right">Derrotas</th>
			<th class="right">Aproveitamento</th>
            <th class="right">Participações</th>
            <th class="right">Faltas s/ sub</th>
            <th class="right">Pagto prazo</th>
            <th class="right">Atrasos</th>
            <th class="right">Total</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r,i)=>`
            <tr>
              <td>${i+1}</td>
              <td>${r.name}${r.active?'':' <span class="muted">(inativo)</span>'}</td>
              <td class="right">${r.jogos||0}</td>
              <td class="right">${r.v||0}</td>
              <td class="right">${r.emp||0}</td>
              <td class="right">${r.der||0}</td>
			  <td class="right">${(r.aprov==null) ? '—' : (r.aprov.toFixed(1).replace('.',',')+'%')}</td>
              <td class="right">${r.part||0}</td>
              <td class="right">${r.falta||0}</td>
              <td class="right">${r.prazo||0}</td>
              <td class="right">${r.atraso||0}</td>
              <td class="right"><b>${r.total>0?'+':''}${r.total}</b></td>
            </tr>`).join('')}
        </tbody>
      </table>
    </div>`;
}

  function byMonth(m,y){ return state.entries.filter(e=>{ const d=new Date(e.date); return d.getUTCFullYear()===y && d.getUTCMonth()===m; }); }
  function byQuarter(q,y){ const [a,b]=qRange(y,q); return state.entries.filter(e=>inRange(e.date,a,b)); }
  function bySemester(s,y){ const [a,b]=sRange(y,s); return state.entries.filter(e=>inRange(e.date,a,b)); }
  function byYear(y){ return state.entries.filter(e=> new Date(e.date).getUTCFullYear()===y ); }
calcMonthly.onclick=()=>{
  const m=Number(rankMonth.value), y=Number(rankYear.value);
  const entries = byMonth(m,y);
  const matches = state.matches.filter(mt=>{
    const d=new Date(mt.date);
    return d.getUTCFullYear()===y && d.getUTCMonth()===m;
  });
  renderRank(rankOutput, aggregate(entries, matches), `Mensal — ${fullMonth(m)} / ${y}`);
};

calcQuarter.onclick=()=>{
  const q=Number(rankQuarter.value), y=Number(rankYear.value);
  const [a,b]=qRange(y,q);
  const label=['Jan–Mar','Abr–Jun','Jul–Set','Out–Dez'][q-1];
  const entries = byQuarter(q,y);
  const matches = state.matches.filter(mt=>inRange(mt.date,a,b));
  renderRank(rankOutput, aggregate(entries, matches), `Trimestral — ${label} / ${y}`);
};

calcSemester.onclick=()=>{
  const s=Number(rankSemester.value), y=Number(rankYear.value);
  const [a,b]=sRange(y,s);
  const entries = bySemester(s,y);
  const matches = state.matches.filter(mt=>inRange(mt.date,a,b));
  renderRank(rankOutput, aggregate(entries, matches), `Semestral — ${s===1?'Jan–Jun':'Jul–Dez'} / ${y}`);
};

calcAnnual.onclick=()=>{
  const y=Number(rankYearOnly.value);
  const entries = byYear(y);
  const matches = state.matches.filter(mt=> new Date(mt.date).getUTCFullYear()===y );
  renderRank(rankOutput, aggregate(entries, matches), `Anual — ${y}`);
};
  saveRankImg.onclick=()=> exportNodeAsPNG(rankOutput, 'ranking.png', 3);

  function paidAmount(pid,m,y){ const p=state.payments.find(x=>x.player_id===pid && x.month===m && x.year===y); return p?Number(p.amount||0):0; }
  function isPaid(pid,m,y){ const pl=state.players.find(p=>p.id===pid); const due=monthlyDueFor(pl,m,y); if(due===0) return true; return paidAmount(pid,m,y) >= due && paidAmount(pid,m,y)>0; }

  function renderMensalistas(){
    if(!mensalistasTable.tHead) mensalistasTable.createTHead();
    const mode = finMensMode.value;           // 'anual' | 'mensal'
    const y    = Number(finYearSel.value);
    const m    = Number(finMensMonth.value);

    let head;
    if(mode==='mensal'){
      head = `<tr><th>Mensalista</th><th class="right">${fullMonth(m)} / ${y}</th><th class="right">Total no ano</th></tr>`;
    }else{
      head = `<tr><th>Mensalista</th>${
        Array.from({length:12},(_,i)=>`<th class="right">${monthName(i)}</th>`).join('')
      }<th class="right">Total</th></tr>`;
    }
    mensalistasTable.tHead.innerHTML = head;

    const tb = mensalistasTable.tBodies[0] || mensalistasTable.createTBody();

    const mAtual = new Date().getUTCMonth();
    const ordemStatus = { isento: 0, pago: 1, em_aberto: 2 };
    const statusNoMes = (p, mes) => {
      const due = monthlyDueFor(p, mes, y);
      if (due === 0) return 'isento';
      return isPaid(p.id, mes, y) ? 'pago' : 'em_aberto';
    };

    const mensalistas = state.players
      .filter(p => p.tipo === 'mensalista')
      .slice()
      .sort((a,b) => {
        const sa = statusNoMes(a, mAtual), sb = statusNoMes(b, mAtual);
        return (ordemStatus[sa]-ordemStatus[sb]) || a.name.localeCompare(b.name,'pt-BR');
      });

    tb.innerHTML = mensalistas.map(p=>{
      const totalAno = state.payments
        .filter(pm => pm.player_id===p.id && pm.year===y)
        .reduce((s,pm)=>s+Number(pm.amount||0),0);

      const tdBadge = (mes)=>{
        const due  = monthlyDueFor(p, mes, y);
        const paid = isPaid(p.id, mes, y);
        const amt  = paidAmount(p.id, mes, y);
        const cls  = due===0 ? '' : (paid ? 'is-paid' : 'is-unpaid');
        const label= due===0 ? 'Isento' : (paid ? `Pago (${fmtMoney(amt)})` : 'Em aberto');
        return `<td class="right"><span class="mensal-badge ${cls}">${label}</span></td>`;
      };

      if(mode==='mensal'){
        return `<tr>
          <td>${p.name}${p.position==='goleiro'?' <span class="muted">(goleiro)</span>':''}</td>
          ${tdBadge(m)}
          <td class="right"><b>${fmtMoney(totalAno)}</b></td>
        </tr>`;
      }else{
        const cells = Array.from({length:12},(_,mi)=>tdBadge(mi)).join('');
        return `<tr>
          <td>${p.name}${p.position==='goleiro'?' <span class="muted">(goleiro)</span>':''}</td>
          ${cells}
          <td class="right"><b>${fmtMoney(totalAno)}</b></td>
        </tr>`;
      }
    }).join('') || `<tr><td colspan="${mode==='mensal'?3:14}" class="muted">Nenhum mensalista configurado.</td></tr>`;

    finMensMonthWrap.style.display = mode==='mensal' ? 'inline-flex' : 'none';
    finMensYearWrap.style.display  = 'inline-flex';
  }
  finMensMode.onchange = renderMensalistas;
  finMensMonth.onchange = renderMensalistas;
  finYearSel.onchange   = renderMensalistas;
    refreshMensalistas.onclick = renderMensalistas;
  saveMensalistasImg.onclick = ()=> exportNodeAsPNG(mensalistasTable, 'mensalistas.png', 3);

  // ===== Fluxo de caixa (com exportar imagem)
  function renderCash(){
    const mode=cashMode.value;
    const y=Number(cashYear.value);
    const m=Number(cashMonth.value);
    let periodCheck;
    if(mode==='mensal'){
      periodCheck = (obj)=> obj.year===y && obj.month===m;
    }else if(mode==='anual'){
      periodCheck = (obj)=> obj.year===y;
    }else{
      periodCheck = ()=>true;
    }
    const inMens = state.payments.filter(p=>periodCheck(p) && (state.players.find(pp=>pp.id===p.player_id)?.tipo)==='mensalista')
                     .reduce((s,p)=>s+Number(p.amount||0),0);
    const inAvul = state.payments.filter(p=>periodCheck(p) && (state.players.find(pp=>pp.id===p.player_id)?.tipo)==='avulso')
                     .reduce((s,p)=>s+Number(p.amount||0),0);
    const outQuad = state.expenses.filter(e=>periodCheck(e) && ((e.kind||'')==='quadra' || /quadra/i.test(e.note||'')))
                     .reduce((s,e)=>s+Number(e.amount||0),0);
    const outOther= state.expenses.filter(e=>periodCheck(e) && !((e.kind||'')==='quadra' || /quadra/i.test(e.note||'')))
                     .reduce((s,e)=>s+Number(e.amount||0),0);
    const net = (inMens+inAvul) - (outQuad+outOther);
    const titulo = mode==='mensal' ? `${fullMonth(m)} / ${y}` : (mode==='anual' ? `Ano ${y}` : 'Total geral');
    cashSummary.innerHTML = `
      <table>
        <thead><tr><th>Período</th><th class="right">Entradas (Mensalistas)</th><th class="right">Entradas (Avulsos)</th><th class="right">Saídas (Pagamento da Quadra)</th><th class="right">Saídas (Outros)</th><th class="right">Total</th></tr></thead>
        <tbody>
          <tr>
            <td>${titulo}</td>
            <td class="right"><span class="mensal-badge is-paid"><b>${fmtMoney(inMens)}</b></span></td>
            <td class="right"><span class="mensal-badge is-paid"><b>${fmtMoney(inAvul)}</b></span></td>
            <td class="right"><span class="mensal-badge is-unpaid"><b>${fmtMoney(outQuad)}</b></span></td>
            <td class="right"><span class="mensal-badge is-unpaid"><b>${fmtMoney(outOther)}</b></span></td>
            <td class="right"><b>${fmtMoney(net)}</b></td>
          </tr>
        </tbody>
      </table>`;
    cashMonthWrap.style.display = mode==='mensal' ? 'inline-flex' : 'none';
    cashYearWrap.style.display  = mode==='total' ? 'none' : 'inline-flex';
  }
  cashMode.onchange=renderCash;
  calcCash.onclick=renderCash;
  cashYear.onchange=renderCash; cashMonth.onchange=renderCash;
  saveCashImg.onclick = ()=> exportNodeAsPNG(cashSummary, 'fluxo_caixa.png', 3);

  /* ==== Placar ==== */
  photoInput.addEventListener('change',()=>{
    const f=photoInput.files?.[0];
    if(!f){ photoPreviewWrap.classList.add('hidden'); photoPreview.src=''; return; }
    const rd=new FileReader();
    rd.onload=e=>{ photoPreview.src=e.target.result; photoPreviewWrap.classList.remove('hidden'); };
    rd.readAsDataURL(f);
  });
  clearPhoto.onclick=()=>{ photoInput.value=''; photoPreview.src=''; photoPreviewWrap.classList.add('hidden'); };

  function getSelectedValues(selectEl){
    return Array.from(selectEl.options).filter(o=>o.selected).map(o=>o.value);
  }

  // controla modo de edição do placar
  let editingMatchId = null;

  saveMatch.onclick=()=>{
    const d = parseBr(matchDateText.value);
    if(!d){ alert('Informe a data em dd/mm/aaaa'); return; }

    const teamAName = (teamA.value||'').trim();
    const teamBName = (teamB.value||'').trim();
    if(!teamAName || !teamBName){ alert('Informe os nomes dos times.'); return; }

    const payload = {
      date: toISODateUTCNoon(d),
      teamAName, teamBName,
      colorA: colorA.value, colorB: colorB.value,
      goalsA: Number(goalsA.value||0),
      goalsB: Number(goalsB.value||0),
      winner: winnerSel.value,
      playersA: getSelectedValues(playersA),
      playersB: getSelectedValues(playersB),
      photo: (!photoPreviewWrap.classList.contains('hidden') && photoPreview.src) ? photoPreview.src : null
    };

    if(editingMatchId){
      const i = state.matches.findIndex(x=>x.id===editingMatchId);
      if(i>=0){
        state.matches[i] = { ...state.matches[i], ...payload, updated_at: nowISO() };
        save();
        renderMatchesFilters();
        renderMatches(editingMatchId);
        alert('Placar atualizado!');
      }
      editingMatchId = null;
      saveMatch.textContent = 'Salvar placar';
    }else{
      const match = { id:'id_'+Math.random().toString(36).slice(2), ...payload, created_at: nowISO() };
      state.matches.push(match);
      save();
      renderMatchesFilters();
      renderMatches(match.id);
      alert('Placar salvo!');
    }
  };

  function loadMatchToForm(m){
    if(!m) return;
    matchDateText.value = fmtBr(m.date);
    teamA.value = m.teamAName||'';
    teamB.value = m.teamBName||'';
    colorA.value = m.colorA||'#60a5fa';
    colorB.value = m.colorB||'#fca5a5';
    goalsA.value = m.goalsA||0;
    goalsB.value = m.goalsB||0;
    winnerSel.value = m.winner||'empate';
    const setA = new Set(m.playersA||[]);
    const setB = new Set(m.playersB||[]);
    Array.from(playersA.options).forEach(o=>o.selected=setA.has(o.value));
    Array.from(playersB.options).forEach(o=>o.selected=setB.has(o.value));
    if(m.photo){ photoPreview.src=m.photo; photoPreviewWrap.classList.remove('hidden'); } else { clearPhoto.click(); }
    matchDateText.scrollIntoView({behavior:'smooth', block:'center'});
  }

  function renderMatchesFilters(){
    const prevY = Number(matchesYear.value||0);
    const prevM = Number(matchesMonth.value||-1);
    const prevD = Number(matchesDay.value||-1);

    const ys = Array.from(new Set(state.matches.map(m=>new Date(m.date).getUTCFullYear()))).sort((a,b)=>a-b);
    matchesYear.innerHTML = '<option value="0">Todos</option>' + ys.map(y=>`<option value="${y}">${y}</option>`).join('');
    if(ys.includes(prevY)) matchesYear.value=String(prevY);

    const curY = Number(matchesYear.value||0);
    const months = Array.from(new Set(state.matches
      .filter(m=>!curY || new Date(m.date).getUTCFullYear()===curY)
      .map(m=>new Date(m.date).getUTCMonth()))).sort((a,b)=>a-b);
    matchesMonth.innerHTML = '<option value="-1">Todos</option>' + months.map(m=>`<option value="${m}">${pad2(m+1)} — ${fullMonth(m)}</option>`).join('');
    if(months.includes(prevM)) matchesMonth.value=String(prevM);

    const curM = Number(matchesMonth.value||-1);
    const days = Array.from(new Set(state.matches
      .filter(m=>(!curY || new Date(m.date).getUTCFullYear()===curY) && (curM<0 || new Date(m.date).getUTCMonth()===curM))
      .map(m=>new Date(m.date).getUTCDate()))).sort((a,b)=>a-b);
    matchesDay.innerHTML = '<option value="-1">Todos</option>' + days.map(d=>`<option value="${d}">${pad2(d)}</option>`).join('');
    if(days.includes(prevD)) matchesDay.value=String(prevD);

    fillMatchesPick();
  }

  function filteredMatches(){
    const y = Number(matchesYear.value||0);
    const m = Number(matchesMonth.value||-1);
    const d = Number(matchesDay.value||-1);
    return state.matches.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).filter(r=>{
      const dt=new Date(r.date);
      const okY = !y || dt.getUTCFullYear()===y;
      const okM = m<0 || dt.getUTCMonth()===m;
      const okD = d<0 || dt.getUTCDate()===d;
      return okY && okM && okD;
    });
  }

  function fillMatchesPick(){
    const rows = filteredMatches();
    matchesPick.innerHTML = rows.map(m=>{
      const label=`${fmtBr(m.date)} — ${m.teamAName} x ${m.teamBName}`;
      return `<option value="${m.id}">${label}</option>`;
    }).join('') || '<option value="">(nenhuma partida)</option>';
  }

  function renderMatches(onlyId=null){
    const rows = filteredMatches();
    let toShow = rows;
    if(onlyId){
      const one = rows.find(r=>r.id===onlyId);
      toShow = one ? [one] : [];
    }else if(matchesPick.value){
      const one = rows.find(r=>r.id===matchesPick.value);
      if(one) toShow = [one];
    }else{
      if(rows[0]) toShow = [rows[0]];
    }

    matchesList.innerHTML = toShow.map(m=>{
      const cA = m.colorA||'#60a5fa', cB = m.colorB||'#fca5a5';
      const img = m.photo ? `<img src="${m.photo}" alt="foto">`
        : `<img src="data:image/svg+xml;charset=UTF-8,${encodeURIComponent(
            "<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='1200'><rect width='100%' height='100%' fill='%230b1220'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%2394a3b8' font-family='sans-serif' font-size='32'>Sem foto</text></svg>"
          )}">`;
      const namesA = (m.playersA||[]).map(id=> state.players.find(p=>p.id===id)?.name||'(removido)').join(', ');
      const namesB = (m.playersB||[]).map(id=> state.players.find(p=>p.id===id)?.name||'(removido)').join(', ');
      const winnerText = m.winner==='empate' ? 'Empate' : `Vencedor: ${m.winner==='A'?m.teamAName:m.teamBName}`;

      return `<div class="banner">
        ${img}
        <div class="overlay"></div>
        <div class="content">
          <div class="match-center">
            <div class="date">${fmtBr(m.date)}</div>
            <div class="teams">
              <span style="color:${cA}">${m.teamAName}</span>
              <span style="color:#fff"> x </span>
              <span style="color:${cB}">${m.teamBName}</span>
            </div>
            <div class="score">
              <span style="color:#fff">${m.goalsA} <span style="color:#fff">x</span> ${m.goalsB}</span>
            </div>
            <div class="placar-vencedor" style="text-align:center;">
              <span class="winner-badge">${winnerText}</span>
            </div>
          </div>
          <div class="players-line">
            <div style="display:flex; justify-content:center; gap:6px; flex-wrap:wrap;">
              <span style="color:${cA}">${namesA||''}</span>
              <span style="color:#fff"> x </span>
              <span style="color:${cB}">${namesB||''}</span>
            </div>
          </div>
        </div>
      </div>`;
    }).join('') || '<div class="muted">Nenhum placar encontrado.</div>';
  }

applyMatchesFilter.onclick=()=>{ renderMatchesFilters(); renderMatches(); };
// Placar da Semana (Histórico): só atualiza os selects (não troca imagem)
matchesYear.onchange = ()=>{ renderMatchesFilters(); };
matchesMonth.onchange = ()=>{ renderMatchesFilters(); };
matchesDay.onchange = ()=>{ fillMatchesPick(); };

  editSelected.onclick=()=>{
    const id=matchesPick.value;
    if(!id){ alert('Selecione uma partida.'); return; }
    const m=state.matches.find(x=>x.id===id);
    if(!m){ alert('Partida não encontrada.'); return; }
    editingMatchId = id;
    saveMatch.textContent = 'Atualizar placar';
    loadMatchToForm(m);
  };
saveMatchImg.onclick = () => {
  const banner = $$('.banner', matchesList);
  if (!banner) {
    alert('Nenhum placar renderizado. Use o filtro/seleção e clique em "Filtrar".');
    return;
  }

  const fullLabel =
    matchesPick.options[matchesPick.selectedIndex]?.textContent?.trim() || 'placar_semana';

  const datePart = fullLabel.split('—')[0].trim();
  const [dd, mm, yyyy] = datePart.split('/');
  const yy = yyyy.slice(-2);

  const filename = `${dd}-${mm}-${yy}.png`;

  exportNodeAsPNG(banner, filename, 3);
};
  deleteSelected.onclick=()=>{
    const id=matchesPick.value;
    if(!id){ alert('Selecione uma partida.'); return; }
    const m=state.matches.find(x=>x.id===id);
    if(!m){ alert('Partida não encontrada.'); return; }
    if(confirm(`Excluir a partida de ${fmtBr(m.date)} — ${m.teamAName} x ${m.teamBName}?`)){
      state.matches = state.matches.filter(x=>x.id!==id);
      save();
      fillChampionYearSelects();
    updateChampionHistPeriodUI();
    fillChampionPick();
    renderChampions();
    renderMatchesFilters(); renderMatches();
    }
  };


  /* ==== Campeões (visualização) ==== */
function championLabel(c){
  const y = Number(c.year);
  const mode = c.mode;

  // MELHOR DA PARTIDA
  if(mode === 'mvp'){
    const m = (state.matches||[]).find(mm => mm.id === c.match_id);
    const dateTxt = m ? fmtBr(m.date) : y;
    return `Melhor da Partida — ${dateTxt}`;
  }

  if(mode==='mensal') return `${fullMonth(Number(c.period)||0)} / ${y} — Mensal`;
  if(mode==='trimestral'){
    const q = Number(c.period)||1;
    const lbl=['Jan–Mar','Abr–Jun','Jul–Set','Out–Dez'][q-1]||`T${q}`;
    return `${lbl} / ${y} — Trimestral`;
  }
  if(mode==='semestral'){
    const s = Number(c.period)||1;
    return `${s===1?'Jan–Jun':'Jul–Dez'} / ${y} — Semestral`;
  }
  return `${y} — Anual`;
}

  function fillChampionYearSelects(){
    const years = new Set();
    state.entries.forEach(en=>years.add(new Date(en.date).getUTCFullYear()));
    state.matches.forEach(m=>years.add(new Date(m.date).getUTCFullYear()));
    state.payments.forEach(p=>years.add(p.year));
    state.expenses.forEach(e=>years.add(e.year));
    state.champions.forEach(c=>years.add(Number(c.year)));
    const ylist = validYearsFromSet(years);
    const yopts = ylist.map(y=>`<option value="${y}">${y}</option>`).join('');
    champHistYear.innerHTML = '<option value="0">Todos</option>' + yopts;
  }

  function fillChampionPeriodSelect(mode, sel){
    if(mode==='mensal'){
      sel.innerHTML = Array.from({length:12},(_,i)=>`<option value="${i}">${pad2(i+1)} — ${fullMonth(i)}</option>`).join('');
      champHistPeriodLabel.textContent = 'Mês';
      return;
    }
    if(mode==='trimestral'){
      sel.innerHTML = `<option value="1">Jan–Mar</option><option value="2">Abr–Jun</option><option value="3">Jul–Set</option><option value="4">Out–Dez</option>`;
      champHistPeriodLabel.textContent = 'Trimestre';
      return;
    }
    if(mode==='semestral'){
      sel.innerHTML = `<option value="1">Jan–Jun</option><option value="2">Jul–Dez</option>`;
      champHistPeriodLabel.textContent = 'Semestre';
      return;
    }
    sel.innerHTML = '';
  }

  function updateChampionHistPeriodUI(){
    const mode = champHistMode.value;
    const show = mode && mode!=='anual';
    champHistPeriodWrap.style.display = show ? 'inline-flex' : 'none';
    if(show){
      fillChampionPeriodSelect(mode, champHistPeriod);
      champHistPeriod.insertAdjacentHTML('afterbegin', `<option value="-1">Todos</option>`);
      champHistPeriod.value = '-1';
    }else{
      champHistPeriod.innerHTML = '';
    }
  }

  function filteredChampions(){
    const y = Number(champHistYear.value||0);
    const mode = champHistMode.value || '';
    const period = (champHistPeriodWrap.style.display!=='none') ? Number(champHistPeriod.value||-1) : -1;

    return state.champions
      .slice()
      .sort((a,b)=> (b.year-a.year) || (String(b.mode).localeCompare(String(a.mode))) || (Number(b.period||0)-Number(a.period||0)))
      .filter(c=>{
        const okY = !y || Number(c.year)===y;
        const okM = !mode || c.mode===mode;
        const okP = (period<0) || (Number(c.period)===period);
        return okY && okM && (mode==='anual' ? true : okP);
      });
  }

  function fillChampionPick(){
    const rows = filteredChampions();
    champPick.innerHTML = rows.map(c=>{
      const p = state.players.find(pp=>pp.id===c.player_id);
      const label = `${championLabel(c)} — ${p?p.name:'(removido)'}`;
      return `<option value="${c.id}">${label}</option>`;
    }).join('') || '<option value="">(nenhum campeão)</option>';
  }

function renderChampionCard(c){
  const p = state.players.find(pp=>pp.id===c.player_id);
  const name = p ? p.name : '(removido)';

  const isMvp = (c.mode === 'mvp');
  const m = isMvp ? (state.matches||[]).find(mm => mm.id === c.match_id) : null;

  // topo do card
  const topText = isMvp ? (m ? fmtBr(m.date) : '') : championLabel(c);

  // badge
  const badgeText = isMvp ? 'Melhor da Partida' : 'Campeão';

  const img = c.photo ? `<img src="${c.photo}" alt="foto">`
    : `<img src="data:image/svg+xml;charset=UTF-8,${encodeURIComponent(
        "<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='1200'><rect width='100%' height='100%' fill='%230b1220'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%2394a3b8' font-family='sans-serif' font-size='34'>Sem foto</text></svg>"
      )}">`;

  return `<div class="banner">
    ${img}
    <div class="overlay"></div>
    <div class="content">
      <div class="match-center">
        <div class="date">${topText || '&nbsp;'}</div>
        <div class="teams" style="font-size:28px">${name}</div>
        <div class="score" style="font-size:16px; margin-top:10px">
          <span class="winner-badge">${badgeText}</span>
        </div>
      </div>
    </div>
  </div>`;
}

  function renderChampions(onlyId=null){
    const rows = filteredChampions();
    let toShow = rows;
    if(onlyId){
      const one = rows.find(r=>r.id===onlyId);
      toShow = one ? [one] : [];
    }else if(champPick.value){
      const one = rows.find(r=>r.id===champPick.value);
      if(one) toShow = [one];
    }else if(rows[0]){
      toShow = [rows[0]];
    }else{
      toShow = [];
    }

    championsList.innerHTML = toShow.map(renderChampionCard).join('') || '<div class="muted">Nenhum campeão encontrado.</div>';
  }

function renderChampionFilters(){
  const y = Number(champHistYear.value || 0);
  const mode = champHistMode.value || '';

  const prevP = Number(champHistPeriod.value || -1);
const showPeriod = mode && mode !== 'anual' && mode !== 'mvp';
champHistPeriodWrap.style.display = showPeriod ? 'inline-flex' : 'none';

// label do período correto
if(mode==='mensal') champHistPeriodLabel.textContent = 'Mês';
else if(mode==='trimestral') champHistPeriodLabel.textContent = 'Trimestre';
else if(mode==='semestral') champHistPeriodLabel.textContent = 'Semestre';
else champHistPeriodLabel.textContent = 'Período';

  if(showPeriod){
    const periods = Array.from(new Set(
      state.champions
        .filter(c => (!y || Number(c.year) === y) && String(c.mode) === mode)
        .map(c => Number(c.period))
    ))
    .filter(n => Number.isFinite(n))
    .sort((a,b)=>a-b);

    const periodLabel = (p)=>{
      if(mode === 'mensal') return `${pad2(p+1)} — ${fullMonth(p)}`;
      if(mode === 'trimestral'){
        const lbl = ['Jan–Mar','Abr–Jun','Jul–Set','Out–Dez'][p-1] || `T${p}`;
        return lbl;
      }
      if(mode === 'semestral') return (p===1 ? 'Jan–Jun' : 'Jul–Dez');
      return String(p);
    };

    champHistPeriod.innerHTML =
      '<option value="-1">Todos</option>' +
      periods.map(p => `<option value="${p}">${periodLabel(p)}</option>`).join('');

    if(periods.includes(prevP)) champHistPeriod.value = String(prevP);
    else champHistPeriod.value = '-1';
  }else{
    champHistPeriod.innerHTML = '';
  }

  fillChampionPick();
}

applyChampFilter.onclick = ()=>{
  renderChampions(champPick.value);
};


champHistMode.onchange = ()=>{ renderChampionFilters(); fillChampionPick(); };
champHistYear.onchange = ()=>{ renderChampionFilters(); fillChampionPick(); };
champHistPeriod.onchange = ()=>{ fillChampionPick(); };
champPick.onchange = ()=>{};


  saveChampionImg.onclick = ()=>{
    const banner = $$('.banner', championsList);
    if(!banner){ alert('Nenhum campeão renderizado.'); return; }
    const opt = champPick.options[champPick.selectedIndex]?.textContent?.trim() || 'campeao';
    const safe = opt.replace(/[^\w\-]+/g,'-').slice(0,60);
    exportNodeAsPNG(banner, `${safe}.png`, 3);
  };


  // ===== Backup
  exportBtn.onclick=()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup_futsal.json'; a.click(); URL.revokeObjectURL(a.href); };
  importBtn.onclick=()=>{ const f=importFile.files?.[0]; if(!f){ alert('Selecione um JSON'); return; } const rd=new FileReader(); rd.onload=e=>{ try{ const obj=JSON.parse(e.target.result); if(!obj||!obj.players||!obj.entries){ throw new Error('Formato inválido'); } state={ payments:[], expenses:[], matches:[], lastEntryId:null, ...obj }; state.payments??=[]; state.expenses??=[]; state.matches??=[]; save(); renderMatchesFilters(); }catch(err){ alert('Falha ao importar: '+err.message); } }; rd.readAsText(f); };

  // Pesquisas A/B nos selects de jogadores
  searchA?.addEventListener('input', renderPlayerSelects);
  searchB?.addEventListener('input', renderPlayerSelects);

  // ===== Refresh & Init
  function refreshUI(){
    renderPlayersSummary(); renderPlayersEditor(); renderPlayerSelects();
    renderHistoryScore(); renderHistoryFin();
    renderMensalistas(); renderCash();
    fillChampionYearSelects();
    renderChampionFilters();
    fillChampionPick();
    renderMatchesFilters(); renderMatches();
  }
 
 (async function init(){

  // 1) Carrega data21h.json primeiro (pra state ter 2025/2026 etc.)
  if(location.protocol === 'file:'){
    console.warn('Abra via servidor (GitHub Pages) para carregar data21h.json automaticamente.');
  } else {
    await loadFromPublicJSON();
  }

  // 2) Agora sim: preenche datas e selects com o state já carregado
  const t=new Date(); 
  const br=pad2(t.getDate())+'/'+pad2(t.getMonth()+1)+'/'+t.getFullYear();
  scoreDateText.value=br; 
  matchDateText.value=br;

  fillMonthYearSelect(histScoreMonth, histScoreYear);
  fillMonthYearSelect(histFinMonth, histFinYear);
  fillMonthYearSelect(payMonth, payYear);
  fillMonthYearSelect(courtMonth, courtYear);
  fillMonthYearSelect(otherMonth, otherYear);

  // Ranking anos (agora vem do data21h.json)
  const years = new Set(Array.from($id('histScoreYear').options).map(o=>Number(o.value)));
  const yopts = validYearsFromSet(years).map(y=>`<option value="${y}">${y}</option>`).join('');
  rankMonth.innerHTML = histScoreMonth.innerHTML;
  rankYear.innerHTML=yopts; 
  rankYearOnly.innerHTML=yopts;

  rankMonth.value=String(new Date().getUTCMonth());
  rankYear.value=String(new Date().getUTCFullYear());
  rankYearOnly.value=String(new Date().getUTCFullYear());

  finYearSel.innerHTML = yopts; 
  finYearSel.value=String(new Date().getUTCFullYear());

  cashMonth.innerHTML = histScoreMonth.innerHTML;
  cashYear.innerHTML  = yopts;
  cashMonth.value=String(new Date().getUTCMonth());
  cashYear.value=String(new Date().getUTCFullYear());

  // Mensalistas (modo mensal/anual)
  finMensMonth.innerHTML = histScoreMonth.innerHTML;
  finMensMonth.value = String(new Date().getUTCMonth());
  finMensMode.value = 'anual';
  finMensMonthWrap.style.display = 'none';

  // 3) Renderiza tudo
  refreshUI();

  // 4) Aplica modo público depois do DOM e dos dados prontos
  if (PUBLIC_MODE) applyPublicMode();

})();
})();
</script>
</body>
</html>
